from scapy.all import *
import datetime
from scapy.arch import get_if_addr

def handle_ping(packet):
    now = datetime.datetime.now()
    if packet[ICMP].type == 8:
        print(f"Received ping from {packet[IP].src} at {now.strftime('%Y-%m-%d %H:%M:%S')}")

def handle_scan(packet):
    if packet.haslayer(TCP) and packet[TCP].flags == 'S':
        if packet[IP].src != get_if_addr(conf.iface):
            port = packet[TCP].sport
            print(f"Port {port} scanned from {packet[IP].src}")

if __name__ == '__main__':
    # define the IP address to listen on
    host = '127.0.0.1'

    # create a filter that looks for incoming ICMP packets
    icmp_filter = 'icmp'

    # create a filter that looks for TCP SYN packets to any destination port
    tcp_filter = f'tcp and dst {host} and tcp.flags==2'

    # combine the filters with an "or" operator
    filter = f"{icmp_filter} or {tcp_filter}"

    # start sniffing for incoming packets
    sniff(filter=filter, prn=lambda x: handle_ping(x) if x.haslayer(ICMP) else handle_scan(x))
